<!--
name: Pending Jobs
description: List of pending jobs
config: config.dashlet.pending_jobs
url: /dashboard/list_pending_jobs
html: /dashlets/pending_jobs.html
title: Pending jobs

-->
<%perl>
    use Baseliner::Utils;
    my @pending_jobs = $c->stash->{pending_jobs};
    my $status_id = "status". _nowstamp;
</%perl>

    <div style="clear:left;border-width:1px;">
        <h2><% _loc("Pending Jobs") %></h2>
        <script language="javascript">
            function render_level_pending ( obj, td_id ) {
                var icon;
                var bold = false;
                var status = obj.status;
                var type   = obj.type;
                var rollback = obj.rollback;
                var div1   = '<div style="white-space:normal !important;">';
                var div2   = '</div>';
                if( status=='RUNNING' ) { icon='gears.gif'; bold=true }
                else if( status=='READY' ) icon='log_d.gif';
                else if( status=='APPROVAL' ) icon='user_delete.gif';
                else if( status=='FINISHED' && rollback!=1 ) { icon='log_i.png'; bold=true; }
                else if( status=='IN-EDIT' ) icon='log_w.gif';
                else if( status=='WAITING' ) icon='waiting.png';
                else if( status=='PAUSED' ) icon='paused.png';
                else if( status=='TRAPPED' ) icon='paused.png';
                else if( status=='TRAPPED_PAUSED' ) icon='paused.png';
                else { icon='log_e.gif'; bold=true; }
                var value = (bold?'<b>' + _(status) + '</b>': _(status));
        
                // Rollback?
                if( status == 'FINISHED' && rollback == 1 )  {
                    value += ' (<% _loc("Rollback OK") %>)';
                    icon = 'log_e.gif';
                }
                else if( status == 'ERROR' && rollback == 1 )  {
                    value += ' (<% _loc("Rollback Failed") %>)';
                }
                //else if( type == 'demote' || type == 'rollback' ) value += ' ' + _('(Rollback)');
                if( status == 'APPROVAL' ) { // add a link to the approval main
                    value = String.format("<a href='javascript:Baseliner.request_approval({0});'><b>{1}</b></a>", obj.mid, _(status) ); 
                }
                
                
                ////alert(icon);
                var tdStatus = document.getElementById( td_id );
                if( icon!=undefined ) {
                    tdStatus.innerHTML = div1 
                        + "<img alt='"+status+"' style='vertical-align:middle' border=0 src='/static/images/icons/"+icon+"' />"
                        + value + div2 ;
                } else {
                    tdStatus.innerHTML = value;
                }
            };
        </script>
            <table style="font-size: 80%;">
                <tr>
                    <td>
                        <table width="550" >
                            <tr>
                                <th style="width:15%"><% _loc("Job") %></th>
                                <th style="width:20%"><% _loc("Status") %></th>
                                <th style="width:15%"><% _loc("Projects") %></th>
                                <th style="width:15%"><% _loc("Start") %></th>
                                <th style="width:15%"><% _loc("End") %></th>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div style="width:550px; height:353px; overflow-y:auto;">
                            <table  class="table table-striped" width="550" >
%my $row = 0;
%foreach my $lastjob (_array @pending_jobs){
%$row = $row + 1;
                                <tr>
                                    <td style="width:15%">
                                        <b>
                                            <a href="javascript:Baseliner.addNewTab('/job/log/dashboard?mid=<%$lastjob->{mid}%>&name=<%$lastjob->{name}%>', _('Log <%$lastjob->{name}%>') );"><%$lastjob->{name}%></a>
                                        </b>
                                        <a href="javascript:Baseliner.add_tabcomp('/job/log/list?mid=<%$lastjob->{mid}%>', _('Log <%$lastjob->{name}%>'), { tab_icon: '/static/images/icons/moredata.gif' } );"><img src="/static/images/icons/moredata.gif"/></a>
                                    </td>
                                    <td style="width:20%" id='row_pending_<%$row%>_<%$status_id%>'><%$lastjob->{status}%></td>
                                    <td style="width:15%"><% length($lastjob->{apps}) ? $lastjob->{apps}: '' %></td>
                                    <td style="width:15%"><% length($lastjob->{starttime}) ? $lastjob->{starttime}: '' %></td>
                                    <td style="width:15%"><% length($lastjob->{endtime}) ? $lastjob->{endtime}: '' %> </td>
                                </tr>
                <script>
                    var details_job = new Object();
                    details_job.status = '<%$lastjob->{status}%>';
                    details_job.type = '<%$lastjob->{type}%>';
                    details_job.rollback = <%$lastjob->{rollback}%>;
                    details_job.mid = '<%$lastjob->{mid}%>';
                    render_level_pending(details_job, 'row_pending_<%$row%>_<%$status_id%>');
                </script>
%}            
                            </table>
                        </div>
                    </td>
                </tr>
        </table>
    </div>

