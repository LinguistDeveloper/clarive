<!--
name: Pending Jobs
description: List of pending jobs
config: config.dashlet.pending_jobs
url: /dashboard/list_pending_jobs
html: /dashlets/pending_jobs.html
title: Pending jobs

-->
<%perl>
    use Baseliner::Utils;
    my @pending_jobs = $c->stash->{pending_jobs};
    my $status_id = "status". _nowstamp;
</%perl>

    <div style="clear:left;border-width:1px;">
        <h2><% _loc("Pending Jobs") %></h2>
        <script language="javascript">
            function render_level_pending ( obj, td_id,status ) {
                var rollback = obj.rollback;
                var status = obj.status;
                var icon = Baseliner.getJobStatusIcon(status, rollback);
                var type   = obj.type;
                var div1   = '<div style="white-space:normal !important;">';
                var div2   = '</div>';
                var value = '<b>' + _(status) + '</b>';

                if( status == 'FINISHED' && rollback == 1 )  {
                    value += ' (<% _loc("Rollback OK") %>)';
                    icon = 'error-triangle-red.svg';
                }
                else if( status == 'ERROR' && rollback == 1 )  {
                    value += ' (<% _loc("Rollback Failed") %>)';
                }

                if( status == 'APPROVAL' ) {
                    value = String.format("<a href='javascript:Baseliner.request_approval(\"{0}\");'><b>{1}</b></a>", obj.mid, _(status) );
                }

                var tdStatus = document.getElementById( td_id );
                if( tdStatus ){
                    if( icon!=undefined ) {
                        tdStatus.innerHTML = div1
                            + "<img alt='"+status+"' style='vertical-align:middle' border=0 src='/static/images/icons/"+icon+"' />"
                            + value + div2 ;
                    } else {
                        tdStatus.innerHTML = value;
                    }
                }
            };
        </script>
            <table style="font-size: 80%;">
                <tr>
                    <td>
                        <table width="550" >
                            <tr>
                                <th style="width:15%"><% _loc("Job") %></th>
                                <th style="width:20%"><% _loc("Status") %></th>
                                <th style="width:15%"><% _loc("Projects") %></th>
                                <th style="width:15%"><% _loc("Start") %></th>
                                <th style="width:15%"><% _loc("End") %></th>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div style="width:550px; height:353px; overflow-y:auto;">
                            <table  class="table table-striped" width="550" >
%my $row = 0;
%foreach my $lastjob (_array @pending_jobs){
%$row = $row + 1;
                                <tr>
                                    <td style="width:15%">
                                        <b>
                                            <a href="javascript:Baseliner.addNewTab('/job/log/dashboard?mid=<%$lastjob->{mid}%>&name=<%$lastjob->{name}%>', _('Log <%$lastjob->{name}%>') );"><%$lastjob->{name}%></a>
                                        </b>
                                        <a href="javascript:Baseliner.add_tabcomp('/job/log/list?mid=<%$lastjob->{mid}%>', _('Log <%$lastjob->{name}%>'), { tab_icon: '/static/images/icons/moredata.svg' } );"><img class="force_size_in_icon" src="/static/images/icons/moredata.svg"/></a>
                                    </td>
                                    <td style="width:20%" id='row_pending_<%$row%>_<%$status_id%>'><%$lastjob->{status}%></td>
                                    <td style="width:15%"><% length($lastjob->{apps}) ? $lastjob->{apps}: '' %></td>
                                    <td style="width:15%"><% length($lastjob->{starttime}) ? $lastjob->{starttime}: '' %></td>
                                    <td style="width:15%"><% length($lastjob->{endtime}) ? $lastjob->{endtime}: '' %> </td>
                                </tr>
                <script>
                    var details_job = new Object();
                    details_job.status = '<%$lastjob->{status}%>';
                    details_job.type = '<%$lastjob->{type}%>';
                    details_job.rollback = <%$lastjob->{rollback}%>;
                    details_job.mid = '<%$lastjob->{mid}%>';
                    render_level_pending(details_job, 'row_pending_<%$row%>_<%$status_id%>');
                </script>
%}
                            </table>
                        </div>
                    </td>
                </tr>
        </table>
    </div>

