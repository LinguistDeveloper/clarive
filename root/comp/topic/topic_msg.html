<%args>
    $ii
    $topic_mid
    $title
    $description
    $comments
    $category
    $category_color
    $created_by
    $created_on
    $priority
    $progress
    $deadline
    $status
    $events
    $files
    $dates
    $release => ''
    $release_row => {}
    $topics
    $parents_topics
    $projects
    $revisions
    $labels
    $users
    $show_priority => 0
    $show_progress => 0
    $show_description => 0
    $show_revisions => 0
    $show_topics => 0
    $show_projects => 0
    $show_assign_to => 0
    $show_files => 0
</%args>
<%perl>
    my @tabactive = _array( $comments ) ? ( 1,0 ) : ( 0,1);
</%perl>
<script language="JavaScript">
    function returnOpposite(hexcolor) {
        var r = parseInt(hexcolor.substr(0,2),16);
        var g = parseInt(hexcolor.substr(2,2),16);
        var b = parseInt(hexcolor.substr(4,2),16);
        var yiq = ((r*299)+(g*587)+(b*114))/1000;
        return (yiq >= 128) ? '000000' : 'FFFFFF';
    }    
</script>
<style>
.badge-rel {
    padding: 15px;    
    width: 400px;
    background: black;
    margin: 50px auto;
}
.badge-rel-inner {
padding: 0px 20px 0px 20px;
    background: white;
border-top-left-radius: 0px;
border-top-right-radius: 0px;
border-bottom-left-radius: 5px;
border-bottom-right-radius: 5px;

-webkit-border-top-left-radius: 0px;
-webkit-border-top-right-radius: 0px;
-webkit-border-bottom-left-radius: 5px;
-webkit-border-bottom-right-radius: 5px;

-moz-border-top-left-radius: 0px;
-moz-border-top-right-radius: 0px;
-moz-border-bottom-left-radius: 10px;
-moz-border-bottom-right-radius: 10px;
}


.arrow_box {
font-size: 10.998px;
text-transform: uppercase;
font-weight: bold;
line-height: 14px;
color: white;
text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
white-space: nowrap;
vertical-align: baseline;
padding: 2px 4px 2px 7px;

    position: relative;
    background: #222;
    border: 2px solid #c2e1f5;
}
.arrow_box:after, .arrow_box:before {
    left: 100%;
    border: solid transparent;
    content: " ";
    height: 0;
    width: 0;
    position: absolute;
    pointer-events: none;
}

.arrow_box:after {
    border-left-color: #222;
    border-width: 10px;
    top: 50%;
    margin-top: -10px;
}
.arrow_box:before {
    border-left-color: #c2e1f5;
    border-width: 13px;
    top: 50%;
    margin-top: -13px;
}

</style>
<div id="boot" class="container_24" style="margin: 10px 10px 10px 10px">
    <div class="grid_24">

% my $id = Baseliner::Utils::_nowstamp();

%if($c->stash->{show_labels}){
% if( _array( $labels ) ) {        
        <div style="margin-bottom:25px;">
% foreach my $label ( _array( $labels ) ) {
            <div id='<%$id . '_' . $label->{name} %>'></div>
            <script language="javascript">
                var label_color = '<% $label->{color} %>';
                var label_name = '<% $label->{name} %>'
                var div_name = '<%$id . '_' . $label->{name} %>'
                var div_label = document.getElementById(div_name);
                div_label.innerHTML = "<span class='label' style='font-size: 9px; float:left;padding:1px 4px 1px 4px;margin-right:4px;color:#" + returnOpposite(label_color) + ";background-color:#" + label_color + "'>" + label_name + "</span>";
            </script>
        
% }
        </div>
% }
% }
          <table class="table table-bordered table-condensed">
            <tbody>
              <tr>
%#if($c->stash->{show_category}){                
                <th width="1" style="vertical-align: middle">
                    <span class="label" style="background: <% $category_color %>"><% $category %> #<% $topic_mid %></span>
                </th>
%#}                
%if($c->stash->{show_title}){
                <th>
                    <h3><% $title %></h3>
                </th>
%}
              </tr>
%if($c->stash->{show_status}){
              <tr>
                <th><% _loc('Status') %>:</th>
                <td><% $status || '&nbsp;' %></td>
              </tr>
%}
%if( $c->stash->{show_release} && $release ){
              <tr>
                <th><% _loc('Release') %>:</th>
                <td><span class="arrow_box" style="padding: 3px; background-color:<% $release_row->{categories}{color} %>"><% $release || '&nbsp;' %></span></td>
              </tr>
%}
              <tr>
                <th><% _loc('Created By') %>:</th>
                <td><% $created_by || '&nbsp;' %></td>
              </tr>
              <tr>
                <th><% _loc('Created On') %>:</th>
                <td><% $created_on ? $created_on->dmy . ' ' . $created_on->hms : '&nbsp;' %></td>
              </tr>
%if($show_priority ){
              <tr>
                <th><% _loc('Priority') %>:</th>
                <td><% $priority || '&nbsp;' %></td>
              </tr>
              <tr>
                <th><% _loc('Deadline') %>:</th>
                <td><% $deadline ? $deadline->dmy . ' ' . $deadline->hms : '&nbsp;' %></td>
              </tr>
%}
%if($show_progress && length $progress ){
              <tr>
                <th><% _loc('Progress') %>:</th>
                <td>
%  my $cls = ( $progress < 20 ? 'danger' : ( $progress < 40 ? 'warning' : ( $progress < 80 ? 'info' : 'success' ) ) );
                    <div class="progress progress-<% $cls %>" style="width: 120px; height: 8px">
                        <div class="bar" style="width: <% $progress %>%"></div>
                    </div>
                </td>
              </tr>
%}              
%if($show_description && length $description ){
              <tr>
                <th colspan="2"><% _loc('Description') %>:</th>
              </tr>
              <tr>
                <td colspan="2"><% $description || '&nbsp;' %></td>
              </tr>
%}              

%if( _array($dates) || ( ($show_projects || $show_assign_to || $show_topics || $show_files)
%       && ( _array($projects) || _array( $users ) || _array( $files ) || _array( $topics ) || _array( $parents_topics ) ) ) ) {                    
              <tr>
                <td colspan="2">
%if( $show_projects ){                    
% if( _array( $projects ) ) {
                    <ul class="nav nav-list">
                      <li class="nav-header">
                        <% _loc("Projects") %>
                      </li>
                    </ul>
                    <ul class="" style="margin-left: 20px">
                      <li class="">
% foreach my $project ( _array( $projects ) ) {
                      <li style="margin: 6px 0px 6px 0px">
                          <% $project->{name} %>
                      </li>
% }
                    </ul>
% }
% }

%if( $show_assign_to ) {                    
% if( _array( $users ) ) {
                    <ul class="nav nav-list">
                      <li class="nav-header">
                        <% _loc("Assign to") %>
                      </li>
                    </ul>
                    <ul class="" style="margin-left: 20px">
                      <li class="">
% foreach my $user ( _array( $users ) ) {
                      <li style="margin: 6px 0px 6px 0px">
                          <img style="margin: 5px" width=16 src="/user/avatar/<% $user->{username} %>/image.png" />
                          <% $user->{username} %> - <% $user->{realname} %>
                      </li>
% }
                    </ul>
% }
% }

%if( 1 || $show_revisions ) {                    
% if( _array( $revisions ) ) {
                    <ul class="nav nav-list">
                      <li class="nav-header">
                        <% _loc("Revisions") %>
                      </li>
                    </ul>
                    <ul class="" style="margin-left: 20px">
                      <li class="">
% foreach my $revision ( _array( $revisions ) ) {
                      <li style="margin: 6px 0px 6px 0px">
                          <img style="margin: 5px" width=16 src="/static/images/icons/tag.gif" />
                          <% $revision->{name} %>
                      </li>
% }
                    </ul>
% }
% }

% if( _array( $dates ) ) {
                    <ul class="nav nav-list">
                      <li class="nav-header">
                        <% _loc("Scheduling") %>
                      </li>
                    </ul>
                    <ul class="" style="margin-left: 20px">
                      <li class="">
% foreach my $date ( _array( $dates ) ) {
%  my $s = $date->{start_date};
%  $s =~ s{00:00:00}{}g;
%  my $e = $date->{end_date};
%  $e =~ s{00:00:00}{}g;
                      <li style="margin: 6px 0px 6px 0px">
                          <% $s."-".$e %>
                      </li>
% }
                    </ul>
% }

%if( $show_topics ){                    
% if( _array( $topics ) ) {
                    <ul class="nav nav-list">
                      <li class="nav-header">
                        <% _loc("Topics") %>
                      </li>
                    </ul>
                    <ul class="" style="margin-left: 20px">
% foreach my $topic ( _array( $topics ) ) {
        
                      <li style="margin: 6px 0px 6px 0px;">
                          <span class="label" onclick="javascript:Baseliner.show_topic(<% $topic->{mid} %>, '<% $topic->{name} %>')" 
                            style="float:left;padding:2px 8px 2px 8px;cursor:pointer;background: <% $topic->{color} %>"><% $topic->{name} %></span>
% my $cls = ( $topic->{progress} < 20 ? 'important' : ( $topic->{progress} < 40 ? 'warning' : ( $topic->{progress} < 80 ? 'info' : 'success' ) ) );
                            &nbsp;&nbsp;<b><% $topic->{title} %></b>&nbsp;&nbsp;
% if($topic->{progress}){                            
                            <span class="badge badge-<%$cls%>"><%$topic->{progress}%>%</span>
%}
                      </li>
% }
                    </ul>
% }

% if( _array( $parents_topics ) ) {
                    <ul class="nav nav-list">
                      <li class="nav-header">
                        <% _loc("Include into") %>
                      </li>
                    </ul>
                    <ul class="" style="margin-left: 20px">
                      <li class="">
% foreach my $topic ( _array( $parents_topics ) ) {
                      <li style="margin: 6px 0px 6px 0px">
                          <span class="label" onclick="javascript:Baseliner.show_topic(<% $topic->{mid} %>, '<% $topic->{name} %>')" 
                            style="float:left;padding:2px 8px 2px 8px;cursor:pointer;background: <% $topic->{color} %>"><% $topic->{name} %></span>
% my $cls = ( $topic->{progress} < 20 ? 'important' : ( $topic->{progress} < 40 ? 'warning' : ( $topic->{progress} < 80 ? 'info' : 'success' ) ) );
                            &nbsp;&nbsp;<b><% $topic->{title} %></b>&nbsp;&nbsp;
% if($topic->{progress}){
                            <span class="badge badge-<%$cls%>"><%$topic->{progress}%>%</span>
%}
                      </li>
% }
                    </ul>
% }





% }


%if($show_files){                    
% if( _array( $files ) ) {
                    <ul class="nav nav-list">
                      <li class="nav-header">
                        <% _loc("Files") %>
                      </li>
                    </ul>
                    <ul class="" style="margin-left: 20px">
                      <li class="">
% foreach my $file ( _array( $files ) ) {
%   my $fii = $ii . '_' . $file->{md5};
%   my $target = $file->{extension} =~ /pdf|htm|html|txt|properties/i ? '_blank' : 'FrameDownload';  # download or try to show on next tab?
%   my ($size,$units) = Baseliner::Utils::_size_unit( $file->{filesize} );
                      <li id="<% $fii %>">
                        <i class="icon-file"></i> 
                        <a href="/topic/download_file/<% $file->{md5} %>/<% $file->{filename} %>" target="<% $target %>">
                          <% Baseliner::Utils::_html_escape( $file->{filename} ) %>
                        </a> (<% $size %> <% $units %>) version <% $file->{versionid} %>
                      </li>
% }
                    </ul>
% }
                    <p>
%#                    <div id="uploader_<% $ii %>"></div>
                    </p>

%}                
                </td>
              </tr>
%} # end mix block
            </tbody>
          </table>
    </div>

    <div class="clear"></div>

    <ul class="nav nav-tabs">
      <li <% $tabactive[0] and 'class="active"' %>>
        <a href="#comments<% $ii %>" data-toggle="tab"><% _loc('Comments') %></a>
      </li>
      <li <% $tabactive[1] and 'class="active"' %>>
        <a href="#activity<% $ii %>" data-toggle="tab"><% _loc('Activity') %></a></li>
    </ul>

    <div class="grid_24">
        <div class="tab-content">
          <div class="tab-pane <% $tabactive[0] and 'active' %>" id="comments<% $ii %>">

% foreach my $com ( _array( $comments) ){
%      my $id_div_com =  "comment_$com->{id}_$ii";

            <div style="margin-left: 20px" id="<% $id_div_com %>">  <!-- class 'well' -->

%      if( $com->{content_type} eq 'code' )  {

                <p><pre id="<% $id_div_com . '_ta' %>"><% $com->{text} %></pre></p>

%#   codemirror does not work well under boot, needs a css reset before
%#                <script>setTimeout( function(){CodeMirror.fromTextArea( document.getElementById("<% $id_div_com . '_ta' %>",
%#                    {lineNumbers: true, tabMode: "indent", smartIndent: true, matchBrackets: true}) );}, 2000)</script>

%      } else {

                <p><% $com->{text} %></p>

%      } 

                <p><small><img style="margin: 0px 5px 2px 0px" width=16 src="/user/avatar/<% $com->{created_by} %>/image.png" />
                    <b><%$com->{created_by}%></b>, <%$com->{created_on}->dmy%> <%$com->{created_on}->hms%>

%    if( $c->username eq $com->{created_by} ) {

                    | <a href="javascript:Baseliner.Topic.comment_edit( undefined, <% $com->{id} %>)"><% _loc("edit") %></a>
                    | <a href="javascript:Baseliner.Topic.comment_delete(<% $com->{id} %>, '<% $id_div_com %>')"><% _loc("delete") %></a>

%    }

                </small></p>
                <hr />
            </div>
%}
          </div>  <!-- comment tab -->

          <div class="tab-pane <% $tabactive[1] and 'active' %>" id="activity<% $ii %>">
%  foreach ( _array( $events ) ) {
            <div style="margin-left: 20px">
             <p><img style="margin: 5px" width=16 src="/user/avatar/<% $_->{username} %>/image.png" /><% $_->{text} %> <small><% $_->{ts} %></small></p>
             <hr />
            </div> 
%}
          </div> <!-- activity tab -->

      </div> <!-- tab content -->
  </div> <!-- lower grid -->
</div> <!-- boot container -->
