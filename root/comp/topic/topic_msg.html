<%args>
    $ii
    $topic_mid
    $topic_meta
    $topic_data
    $permissionJobs => 0
    $permissionJobsLink => 0
    $has_comments
    $HTMLbuttons => 0
    $permissionEdit => 0
    $permissionDelete => 0
    $permissionComment => 0
    $permissionActivity => 0
    $permissionDashboard => 1
    $user_security
    $dashboard => ''
</%args>
<%perl>
    use Baseliner::Utils;
 
    my @form = grep { $_->{fields} } _array( $topic_meta );
    my @head = sort { $a->{field_order} <=> $b->{field_order} } grep { $_->{section} && $_->{section} eq 'head' } _array( $topic_meta );
    my @details = sort { $a->{field_order} <=> $b->{field_order} } grep { $_->{section} && $_->{section} eq 'details' } _array( $topic_meta );
    my @between = sort { $a->{field_order} <=> $b->{field_order} } grep { $_->{section} && $_->{section} eq 'between' } _array( $topic_meta );
    my @body = sort { $a->{field_order} <=> $b->{field_order} } grep { $_->{section} && $_->{section} eq 'body' } _array( $topic_meta ) ;
    my @more = sort { $a->{field_order} <=> $b->{field_order} } grep { $_->{section} && $_->{section} eq 'more' } _array( $topic_meta ) ;
    my $tabactive = $has_comments ? 'discussion' : 
        $permissionDashboard && length($dashboard) ? 'dashboard' : 
        @more ? 'more' :
        $permissionActivity ? 'activity' : 
        $permissionJobs ? 'jobs' : 
        'none';

</%perl>
<style>
.badge-rel {
    padding: 15px;    
    width: 400px;
    background: black;
    margin: 50px auto;
}
.badge-rel-inner {
padding: 0px 20px 0px 20px;
    background: white;
border-top-left-radius: 0px;
border-top-right-radius: 0px;
border-bottom-left-radius: 5px;
border-bottom-right-radius: 5px;

-webkit-border-top-left-radius: 0px;
-webkit-border-top-right-radius: 0px;
-webkit-border-bottom-left-radius: 5px;
-webkit-border-bottom-right-radius: 5px;

-moz-border-top-left-radius: 0px;
-moz-border-top-right-radius: 0px;
-moz-border-bottom-left-radius: 10px;
-moz-border-bottom-right-radius: 10px;
}


.arrow_box {
font-size: 10.998px;
text-transform: uppercase;
font-weight: bold;
line-height: 14px;
color: white;
text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
white-space: nowrap;
vertical-align: baseline;
padding: 2px 4px 2px 7px;

    position: relative;
    background: #222;
    border: 2px solid #c2e1f5;
}
.xarrow_box:after, .xarrow_box:before {
    left: 100%;
    border: solid transparent;
    content: " ";
    height: 0;
    width: 0;
    position: absolute;
    pointer-events: none;
}

.arrow_box:after {
    border-left-color: #222;
    border-width: 10px;
    top: 50%;
    margin-top: -10px;
}
.arrow_box:before {
    border-left-color: #c2e1f5;
    border-width: 13px;
    top: 50%;
    margin-top: -13px;
}

</style>
<script>
$('.bali-topic-editor-image').click(function(){
    var imagen = $(this);
    imagen.css('display', 'block');
    var src = $(this).attr('src');
    var captura = new Baseliner.Window({ title:'Zoom image', width: ($(window).width() - 20), height: ($(window).height() - 20),
        closable: true, autoScroll: true, layout:'fit', html: "<img src="+src+"/>" });
if (imagen.width()>600) { captura.show(); }
});
</script>
% if (@form) {
<div id="boot" >
% foreach my $field (  @form ) {
% if ($field->{html}){
    <& $field->{html}, data=>$topic_data, meta=>$field, html_buttons=>$HTMLbuttons, show_buttons=>$permissionEdit, show_comments=>$permissionComment &>
%}
% }
% }else {
<div id="boot">
    <table width="100%">
        <tr>
        <td width="60%">
        <!-- div class="span7" style="xwidth: 60%" -->
            <table style="width: 100%">
                <tbody>
% foreach my $field ( @head ) {
% if ($field->{html}){
    <!-- <% $field->{html} %> -->
    <& $field->{html}, data=>$topic_data, meta=>$field, user_security=>$user_security&>
%}
% }
                </tbody>
            </table>
        <!-- /div -->
        </td>

<!-- ******** right box ********** -->
        <td width="40%" style="padding-left: 15px;">
            <table style="width: 100%" class="table table-bordered table-condensed">
                <tbody>
%foreach my $field ( @body ) {
     <!--    <tr>
            <td colspan=2 > -->
%   if ($field->{html}){
        <& $field->{html}, data=>$topic_data, meta=>$field, user_security=>$user_security &>
%   } 
<!--             </td>
        </tr>    -->
%}

% if( @between ) {
        <tr>
            <td colspan=2>
%foreach my $field ( @between ) {
%   if ($field->{html}){
        <& $field->{html}, data=>$topic_data, meta=>$field, user_security=>$user_security &>
%   }
%   elsif ($field->{js_file}){
%     my $graph_id = "dashfield-" . Util->_md5();
      <div id='boot' style="clear:left;" >
      	<b><%$field->{name_field}%></b><br>
        <div id="<%$graph_id%>" 
            style="width: <% $field->{field_width} || '100%' %>; height: <% $field->{field_height} || '220px' %>; text-align: center; vertical-align: middle;"
			onmouseout="document.body.style.cursor='default';"
            class="field-dashlet"
            js_file='<% $field->{js_file} %>'
            dashlet_data='<% Util->_encode_json($field->{data}) %>'
            ></div>
      </div>
      <div style="clear:left;" ></div>
%   }
%}                                 
            </td>
        </tr>
% } 


% if( @details ) {
%    my $did = int rand 999999;
        <tr>
            <td colspan=2 id="<% $did %>" style="white-space: nowrap; display: none;">
% foreach my $field ( @details ) {
%   if ($field->{html}){
        <& $field->{html}, data=>$topic_data, meta=>$field, user_security=>$user_security &>
%   }
%}                                 
            </td>
        </tr>
        <script>
            var dtd = Ext.fly( '<% $did %>' );
            if( dtd.dom.innerHTML.trim().length > 0 ) dtd.show();
        </script>
% }
                </tbody>
            </table>
        </td>
    </tr>
</table>
%}

<div class="clear"></div>
    <br><br>
    <ul class="nav nav-tabs" id="nav-tabs-<% $ii %>">
        <li <% $tabactive eq 'discussion' and 'class="active"' %> <%  $permissionComment? '' : ' style="display: none" ' %>>
            <a href="#discussion<% $ii %>" id="tab-discussion<% $ii %>" data-toggle="tab"><% _loc('Discussion') %></a>
        </li>
        <li <% $tabactive eq 'activity' and 'class="active"' %> <%  $permissionActivity? '' : ' style="display: none" ' %>>
            <a href="#activity<% $ii %>" id="tab-activity<% $ii %>" data-toggle="tab"><% _loc('Activity') %></a>
        </li>
        <li <% $tabactive eq 'jobs' and 'class="active"' %> <%  $permissionJobs? '' : ' style="display: none" ' %>>
            <a href="#jobs<% $ii %>" id="tab-jobs<% $ii %>" data-toggle="tab"><% _loc('Jobs') %></a>
        </li>
% if( length $dashboard ) {    
        <li <% $tabactive eq 'dashboard' and 'class="active"' %> <%  $permissionDashboard? '' : ' style="display: none" ' %>>
            <a href="#dashboard<% $ii %>" id="tab-dashboard<% $ii %>" data-toggle="tab"><% _loc('Dashboard') %></a>
        </li>
% } 
% if( @more ) {    
        <li <% $tabactive eq 'more' and 'class="active"' %>>
            <a href="#more<% $ii %>" id="tab-more<% $ii %>" data-toggle="tab"><% _loc('More info') %></a>
        </li>
% } 
<!--         <li <% $tabactive eq 'timeline' and 'class="active"' %>>
            <a href="#timeline<% $ii %>" id="tab-timeline<% $ii %>" data-toggle="tab"><% _loc('Timeline') %></a>
        </li>
 -->    </ul>

    <div class="grid_24">
        <div class="tab-content">
            <div class="tab-pane <% $tabactive eq 'discussion' and 'active' %>" id="discussion<% $ii %>">
                <div id="topic-discussion<% $ii %>"><img src="/static/images/loading-fast.gif" style="padding-left: 5px" /></div>
            </div>  <!-- discussion tab -->

            <div class="tab-pane <% $tabactive eq 'activity' and 'active' %>" id="activity<% $ii %>">
                <div id="topic-activity<% $ii %>"><img src="/static/images/loading-fast.gif" style="padding-left: 5px" /></div>
            </div> <!-- activity tab -->

            <div class="tab-pane <% $tabactive eq 'jobs' and 'active' %>" id="jobs<% $ii %>">
                <div id="topic-jobs<% $ii %>"><img src="/static/images/loading-fast.gif" style="padding-left: 5px" /></div>
            </div> <!-- jobs tab -->

            <div class="tab-pane <% $tabactive eq 'dashboard' and 'active' %>" id="dashboard<% $ii %>">
                <div id="topic-dashboard<% $ii %>"><img src="/static/images/loading-fast.gif" style="padding-left: 5px" /></div>
            </div> <!-- dashboard tab -->

            <div class="tab-pane <% $tabactive eq 'more' and 'active' %>" id="more<% $ii %>">
                <div id="topic-more<% $ii %>">
% if( @more ) {
                    <tr>
                        <td colspan=2 >
% foreach my $field ( @more ) {
% if ($field->{html}){
    <!-- <% $field->{html} %> -->
    <& $field->{html}, data=>$topic_data, meta=>$field, user_security=>$user_security &>
%}
% }                                 
                            
                        </td>
                    </tr>
% } 

                </div>
            </div> <!-- more tab -->

            <div class="tab-pane <% $tabactive eq 'timeline' and 'active' %>" id="timeline<% $ii %>">
                <div id="topic-timeline<% $ii %>" style="border: 1px solid #aaa"></div>
            </div> <!-- timeline tab -->

            <script>
                (function(){   // protect scope
                    var build_topic_tabs = function(topic_mid, ii, target_id){
                        if( target_id == "tab-timeline"+ii && topic_mid != '' ) {
                            Baseliner.timeline({ 
                                mid: topic_mid,
                                render_to: "topic-timeline"+ii,
                                parent_id: ii
                            });
                        } else if( target_id == "tab-discussion"+ii && topic_mid != '' ) {
                            Baseliner.comments_for_topic({ 
                                mid: topic_mid,
                                render_to: "topic-discussion"+ii,
                                parent_id: ii
                            });
                        } else if( target_id == "tab-activity"+ii && topic_mid != '' ) {
                            Baseliner.activity_for_topic({ 
                                mid: topic_mid,
                                render_to: "topic-activity"+ii,
                                parent_id: ii
                            });
                        } else if( target_id == "tab-jobs"+ii && topic_mid != '' ) {
                            Baseliner.jobs_for_topic({ 
                                mid: topic_mid,
                                render_to: "topic-jobs"+ii,
                                parent_id: ii,
                                link: <% $permissionJobsLink %>
                            });
                        } else if( target_id == "tab-dashboard"+ii && topic_mid != '' ) {
                            var dashboard_rule = '<% $dashboard %>'; 
                            if( dashboard_rule.length > 0 ) {
                                var dashboard_id = "topic-dashboard"+ii;
                                var jq_dash = $('#'+dashboard_id);
                                var dashboard_off = "off-topic-dashboard"+ii;
                                var jq_dash_off = $('#'+dashboard_off);
                                if( !jq_dash.attr('setup') ) {
                                    jq_dash.show();
                                    jq_dash.attr('setup', true);
                                    var dashboard = new Cla.Dashboard({ title: undefined, 
                                            bodyStyle:'border:0', dashboard_id: dashboard_rule, topic_mid: topic_mid });
                                    dashboard.on('afterrender',function(){
                                        jq_dash.html('');
                                    });
                                    dashboard.render( dashboard_off );
                                }
                            }
                        }// if tab

                        // sync dashboard div with tab div
                        if( /dashboard/.test(target_id) ) 
                            $( '#off-topic-dashboard'+ii ).show();
                        else
                            $( '#off-topic-dashboard'+ii ).hide();
                        
                    };
                    //$("#timeline<% $ii %> a").click(function(){});
                    var curr_tab = "<% $tabactive %>";
                    build_topic_tabs('<% $topic_mid %>', '<% $ii %>', 'tab-'+curr_tab+'<% $ii %>' );
                    $('#nav-tabs-<% $ii %> a[data-toggle="tab"]').on('shown', function (ev) {
                        build_topic_tabs('<% $topic_mid %>', '<% $ii %>', ev.target.id );
                    }); // on shown
               })()
            </script>
        </div> <!-- tab content -->
    </div> <!-- lower grid -->
</div> <!-- boot container -->
<!-- put this here so we don't have bootstrap if we don't want to -->
<div style="margin: 0; padding: 0; border: 0; display: none" id="off-topic-dashboard<% $ii %>"></div>
