<%args>
    $rows
    $title => 'Log'
    $job_name
    $job_exec
    $job_exec_total
    $job_key
    $debug => 0
    $with_data => 0
    $sort => 0
</%args>
<%perl>
    my $url_build = sub {
        my %p = @_;
        $p{with_data} //= $with_data;
        $p{debug} //=  $debug;
        $p{sort} //= $sort;
        $p{job_exec} ||= $job_exec;
        delete $p{job_exec} if $p{job_exec} < 0 ;
        return "/job/log/html/${job_key}?" . join '&',
            map { $_ . '=' . $p{$_} }
            sort keys %p
    };
</%perl>
<head>
  <& '/site/nocache.html' &>

  <title><% $title %></title>

  <style><& /static/geek.css &></style>
  <style>
    tr,
    td,
    body {
        font: normal 10px 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
    }

    #log-html h1 {
        font-size: 20px;
        margin: 15px 0 15px 0;
    }

    #log-html {
        clear: right;
        padding-top: 5px;
    }

    #top {
        float: right;
    }

    .summary-table {
        width: 100%;
        margin-top: 35px;
    }

    body {
        font-family: 'Tahoma';
        font-size: '10px';
    }

    hr {
        height: 1px;
        color: #eee;
        background-color: #ccc;
        border: 0;
        border-style: solid;
    }

    img {
        border: 0;
    }

    td {
        font-size: '8pt';
    }

    tr * {
        border-bottom: 1px solid #e8e8e8 !important;
    }

    .titles th,
    .titles td {
        border-bottom: 1px solid black !important;
    }

    #top a {
        font-size: 12px;
        color: #616161 !important;
        border-bottom: none !important;
        padding-bottom: .08em;
        line-height: 1.70 !important;
        text-decoration: none !important;
        cursor: pointer;
    }

    #top a:hover {
        color: #a0a0a0 !important;
        text-decoration: none !important;
        border-bottom: .08em solid #a0a0a0 !important;
        padding-bottom: .08em;
    }

    pre {
        font-family: Consolas, Monaco, "Courier New", Courier, monospace;
        padding: 6px;
        border: #ddd dashed 1px;
        font-size: "11px";
    }

    .summary-name.step-title {
        width: 1%;
    }

    .summary-name.task-title {
        width: 11%;
    }

    .summary-name.pid-title {
        width: 6%;
    }

    .summary-name.timestamp-title {
        width: 12%;
    }

    .summary-name.message-title {
        width: 66%;
    }

    .summary-name.actions-title {
        width: 1%;
    }

    .summary-table * td {
        max-width: 66%;
    }

    tr b,
    tr a {
        border-bottom: none !important
    }

    .info-odd,
    .info-even,
    .warn-odd,
    .warn-even,
    .error-odd,
    .error-even,
    .debug-odd,
    .debug-even {
        background-color: #ffffff;
    }

    .force_size_in_icon {
        height: 13px;
        width: 13px;
        border-bottom: 1px solid white !important;
    }

    a.force_size_in_icon:hover {
        text-decoration: none !important;
    }

    .timestamp {
        background: url("/static/images/icons/time.svg") no-repeat;
        background-size: 13px;
        vertical-align: middle;
        background-position: 0 50%;
        padding-left: 19px !important;
    }

    td.check,
    td.init,
    td.pre,
    td.run,
    td.post,
    td.run,
    td.end {
        background-size: 21px;
        vertical-align: middle;
        background-position: 0 50%;
        padding-left: 22px;
        background-repeat: no-repeat;
    }

    .step.error-even,
    .step.error-odd,
    .step.warn-even,
    .step.warn-odd,
    .step.info-even,
    .step.info-odd,
    .step.debug-even,
    .step.debug-odd {
        background-size: 13px;
        vertical-align: middle;
        background-position: 0 50%;
        padding-left: 22px;
        background-repeat: no-repeat;
    }

    .step.error-even,
    .step.error-odd {
        background-image: url("/static/images/icons/error.svg");
    }

    .step.warn-even,
    .step.warn-odd {
        background-image: url("/static/images/icons/warning.svg");
    }

    .step.info-even,
    .step.info-odd {
        background-image: url("/static/images/icons/active.svg");
    }

    .step.debug-even,
    .step.debug-odd {
        background-image: url("/static/images/icons/debug-view.svg");
    }

    .summary-name {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size: 14px;
        background: none !important;
        border: none !important;
    }
  </style>
</head>

<body>
<center>
<div id="top">
% if( $debug ) {
    <a class="debug" href="<% $url_build->( debug=>0 ) %>">No Debug</a>
% } else {
    <a class="debug" href="<% $url_build->( debug=>1 ) %>">Debug</a>
% }
|
<% _loc("Sort") %>:
% if( $sort ) {
    <a href="<% $url_build->( sort=>'' ) %>"><% _loc("Chronological") %></a>
% } else {
    <a href="<% $url_build->( sort=>'id desc' ) %>"><% _loc("Reverse") %></a>
% }
|
% if( $with_data ) {
    <a href="<% $url_build->( with_data => 0 ) %>"><% _loc("Hide Data") %></a>
% } else {
    <a href="<% $url_build->( with_data=>1 ) %>"><% _loc("View Data") %></a>
% }
% if( $job_exec_total > 1 ) {
|
Exec:
<select id="exec" onchange='window.location = "<% $url_build->( job_exec=>-1 ) %>&job_exec=" + this.value '>
%    for my $ex ( 1..$job_exec_total ) {
        <option value="<% $ex %>" <% $ex eq $job_exec ? 'selected' : '' %>><% $ex %></option>
%    }
</select>
% }
</div>

<div id="log-html">
    <h1>Log <% $job_name %> (<% $job_exec %>)</h1>

<table class="summary-table">
  <tbody>
    <tr>
        <th class="summary-name step-title" width="1"><% _loc( 'Step' ) %></th>
        <th class="summary-name task-title" width="1"><% _loc( 'Task' ) %></th>
%    if( $debug ) {
        <th class="summary-name pid-title" width="1"><% _loc( 'PID' ) %></th>
%    }
        <th class="summary-name timestamp-title" width="1"><% _loc( 'Timestamp' ) %></th>
        <th class="summary-name message-title"><% _loc( 'Message' ) %></th>
        <th class="summary-name actions-title"><% _loc( 'Actions' ) %></th>
    </tr>

% my $k = 0;
% my $eo = sub { [ '-even', '-odd' ]->[ $k % 2 ] };

% for my $row ( @$rows ) {
    <tr class="<% $row->{lev} . $eo->()  %>">
        <td class="step <% $row->{step} %> <% $row->{lev} . $eo->() %>"><% $row->{step} %></td>
        <td class=" <% $row->{lev} . $eo->() %>"><% $row->{service_key} %></td>
%    if( $debug ) {
        <td class="<% $row->{lev} . $eo->() %>"><% $row->{pid} %></td>
%    }
        <td class="timestamp <% $row->{lev} . $eo->()  %>"><% $debug ? ( $row->{ts} . '.' . (split/\./, $row->{t})[1] ) : $row->{ts} %></td>
        <td class="message <% $row->{lev} . $eo->()  %>"><% $row->{text} %></td>
        <td class="<% $row->{lev} . $eo->()  %>">
% if( $row->{datalen} ) {
%     if( $row->{more}->{more} ) {
            <a href="/job/log/download_data?id=<% $row->{id} %>"><% $row->{more}->{file} %></a>
%     } else {
            <a target="_blank" href="/job/log/data/<% $row->{id} %>"><img class="force_size_in_icon" src="/static/images/icons/job-full-log.svg" alt="<% _loc("view") %>" /></a>
%     }
% }
        </td>
    </tr>

%   if( $with_data && $row->{datalen} && !$row->{more}->{more} ) {
        <tr><td class="data" colspan=4><pre><% $row->{data} %></pre></td></tr>
%   }

%   if( $row->{milestone} ) {
       <!--  <tr><td colspan=4> <hr /><p></p></td></tr> -->
%   }

%   $k++;
% } # rows
   </tbody>
</table>
</div>
</body>

