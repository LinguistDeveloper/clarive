#!/usr/bin/env sh
# starts the web server
export LIBPATH=$BASELINER_LIBPATH:$LIBPATH

if [ "$BASELINER_NLS_LANG" != "" ]; then
	export NLS_LANG=$BASELINER_NLS_LANG
fi

if [ "$BASELINER_LANG" != "" ]; then
	export LANG=$BASELINER_LANG
fi

if [ "$BALI_ENV" != "" ]; then
	export CATALYST_CONFIG_LOCAL_SUFFIX=$BALI_ENV
fi

if [ "$BASELINER_ENV" != "" ]; then
	export CATALYST_CONFIG_LOCAL_SUFFIX=$BASELINER_ENV
fi

if [ "$BASELINER_LOGHOME" != "" ]; then
	LOGDIR=$BASELINER_LOGHOME
else
	LOGDIR=$BASELINER_HOME/tmp/log
	mkdir -p $LOGDIR
fi

LOGFILENAME=bali_web
NOW=`perl -MDateTime -le 'print DateTime->now()'`
LOGFILEOLD=$LOGDIR/${LOGFILENAME}_${NOW}.log
LOGFILE=$LOGDIR/$LOGFILENAME.log
PIDFILE=$LOGDIR/bali_web.pid
test_char=`echo "\c"`
nonl='\c'
echop=''
if [ "$test_char" == '\c' ]; then
	nonl=''	
	echop='-n'
fi

if [ "$1" = "start" ]; then
    if [ "$1" != "" ]; then
        shift 
    fi
    if [ -e $PIDFILE ]; then
        FILE_PID=`cat $PIDFILE`
        kill -0 $FILE_PID 2>/dev/null
        if [ $? = 0 ]; then
                echo "Server is already running."
                exit 1;
        else
                rm $PIDFILE
        fi
    fi
    mv "$LOGFILE" "$LOGFILEOLD" 2>/dev/null
	gzip $LOGFILEOLD 2>/dev/null
    echo "Log file: $LOGFILE"
    cd $BASELINER_HOME
    #nohup perl script/baseliner_server.pl $BASELINER_SERVER_ARGS $* > $LOGFILE 2>&1 &
    BASELINER_ENGINE=prefork nohup perl $BASELINER_SERVER_PERLARGS script/baseliner_server.pl $BASELINER_SERVER_ARGS $* > $LOGFILE 2>&1 &
    SERVER_PID=$!
    echo $SERVER_PID > $PIDFILE
    echo "Server started with pid: $SERVER_PID"
    echo $echop "Waiting for children to start...$nonl"
    k=0
    while [ $k -lt 10 ]
    do
        sleep 1
        echo $echop ".$nonl"
        let k=k+1
    done 
    CHILDREN=`ps -ef|grep perl|grep baseliner_|perl -n -e 'next unless /$SERVER_PID/; @a=split / /; print \$a[2]," "'`
	echo ""
    echo "Children started: " . $CHILDREN;
elif [ "$1" = "stop" ]; then
    if [ -e $PIDFILE ]; then
        SERVER_PID=`cat $PIDFILE`
        echo "Server pid: $SERVER_PID"
        kill -s INT $SERVER_PID 2>/dev/null
        if [ $? = 0 ]; then
                echo "Server stopped."
        else
                echo "Server is not running."
        fi
        rm "$PIDFILE"
    else
        echo "Server was not running or no pid file. No action taken."
    fi
elif [ "$1" = "kill" ]; then
    if [ -e $PIDFILE ]; then
        SERVER_PID=`cat $PIDFILE`
        echo "Killing Baseliner Server with pid: $SERVER_PID"
        kill -9 $SERVER_PID 2>/dev/null
    fi
    COUNT1=`ps uwwx | grep perl | grep "baseliner_server.pl" | grep -v grep | wc -l`
    COUNT2=`ps uwwx | grep perl | grep "bali server" | grep -v grep | wc -l`
    COUNT=`perl -e '$x+=$_ for @ARGV; print $x' $COUNT1 $COUNT2`
    if [ "$COUNT" -gt 0 ]; then
        echo "Killing all Baseliner Web server processes..."
        ps uwwx | grep perl | grep "baseliner_server.pl" | perl -a -n -l -e 'print join" ",">> ",$F[1]," => ",@F[10..$#F]'
        ps uwwx | grep perl | grep "baseliner_server.pl" | perl -a -n -l -e 'kill 9,$F[1]'
        ps uwwx | grep perl | grep "bali.server" | perl -a -n -l -e 'print join" ",">> ",$F[1]," => ",@F[10..$#F]'
        ps uwwx | grep perl | grep "bali.server" | perl -a -n -l -e 'kill 9,$F[1]'
        echo "Done."
    fi
elif [ "$1" = "restart" ]; then
    shift
    bali-web stop
    bali-web kill
    bali-web start $*
elif [ "$1" = "tail" ]; then
    tail -10000f $LOGFILE
else
    echo "Unkown operation $1"
fi

