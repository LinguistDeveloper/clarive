#!/bin/bash

#set -x

BINDIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
LOCALDIR="$BINDIR/../../local"
PERL="$LOCALDIR/bin/perl"
if [ ! -e $PERL ]; then
    PERL=`which perl`
fi
export CLARIVE_BASE="$BINDIR/../../"
export CLARIVE_HOME="$CLARIVE_BASE/clarive"
export PATH="$BINDIR:$LOCALDIR/perl/bin:$LOCALDIR/bin:$LOCALDIR/sbin:$PATH"
export LD_LIBRARY_PATH="$LOCALDIR/lib"

export PERL5LIB=""
export PERL_LOCAL_LIB_ROOT=""

export NODE_MODULES="$LOCALDIR/lib/node_modules"

if [ "$1" == "exec" ]; then
    shift

    if [ "$1" == "nginx" ]; then
        cd $LOCALDIR/sbin
    fi

    "$@"
elif [ "$1" == "cpanm" ]; then
    shift

    export PERL_MB_OPT="--installdirs site"
    export PERL_MM_OPT="INSTALLDIRS=site"

    cpanm --mirror-only --mirror http://cpan.clarive.com "$@"
elif [ "$1" == "stew" ]; then
    shift
    CMD=$1
    shift

    stew $CMD --repo http://sources.clarive.com --base $CLARIVE_BASE "$@"
elif [ "$1" == "bootstrap" ]; then
    shift

    cla-bootstrap "$@"
else
    $PERL $BINDIR/cla-cmd "$@"
fi
