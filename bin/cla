#!/bin/bash

#set -x

[ "${0:0:1}" == "/" ]
RELATIVE=$?

BINDIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
LOCALDIR=`$BINDIR/realpath "$BINDIR/../../local"`
PERL="$LOCALDIR/bin/perl"
if [ ! -e $PERL ]; then
    PERL=`which perl`
fi
export PATH="$BINDIR:$LOCALDIR/bin:$LOCALDIR/sbin:$PATH"
if [ "$CLARIVE_BASE" == "" ] || [ "$RELATIVE" == "1" ]; then
    export CLARIVE_BASE=`realpath "$BINDIR/../../"`
fi
if [ "$CLARIVE_HOME" == "" ] || [ "$RELATIVE" == "1" ]; then
    export CLARIVE_HOME=`realpath "$BINDIR/../"`
fi
export LD_LIBRARY_PATH="$LOCALDIR/lib:$LD_LIBRARY_PATH"

export PERL5LIB=""
export PERL_LOCAL_LIB_ROOT=""
export PERL_MB_OPT="--installdirs site"
export PERL_MM_OPT="INSTALLDIRS=site"

export NODE_MODULES="$LOCALDIR/lib/node_modules"

# Old profile.sh cleanup
export PERLHOME=""
export PERL_CPANM_OPT=""

if [ "$1" == "exec" ]; then
    shift

    if [ "$1" == "nginx" ]; then
        cd $LOCALDIR/sbin
    fi

    "$@"
elif [ "$1" == "cpanm" ]; then
    shift

    perl bin/cpanm --mirror-only --mirror http://cpan.clarive.com "$@"
elif [ "$1" == "stew" ]; then
    shift
    CMD=$1
    shift

    stew $CMD --repo http://sources.clarive.com --base $CLARIVE_BASE "$@"
elif [ "$1" == "bootstrap" ]; then
    shift

    cla-bootstrap "$@"
elif [ "$1" == "prove" ]; then
    shift

    ARGV=( "$@" )

    if [ $# -eq 0 ]; then
        ARGV[0]=t;
    fi

    perl $LOCALDIR/bin/prove -Ilib -It/lib -I$CLARIVE_HOME/lib -I$CLARIVE_HOME/t/lib -r "${ARGV[@]}"
elif [ "$1" == "proveui" ]; then
    shift

    ARGV=( "$@" )

    if [ $# -eq 0 ]; then
        ARGV[0]=tselenium;
    fi

    perl $LOCALDIR/bin/prove -Ilib -It/lib -Itselenium/lib -I$CLARIVE_HOME/lib -I$CLARIVE_HOME/t/lib  -I$CLARIVE_HOME/tselenium/lib -r "${ARGV[@]}"
elif [ "$1" == "cover" ]; then
    shift

    cover -delete -silent
    prove -Ilib -It/lib -e 'bin/cla exec perl -It/lib -Ilib -MDevel::Cover=-coverage,statement,branch,condition,path,subroutine,time' -I$CLARIVE_HOME/lib -I$CLARIVE_HOME/t/lib -r "$@"
    cover
else
    $PERL $BINDIR/cla-cmd "$@"
fi
