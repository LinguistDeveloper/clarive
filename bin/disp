#!/usr/bin/env sh 

if [ "$BASELINER_LOGHOME" != "" ]; then
    LOGDIR=$BASELINER_LOGHOME
else
    LOGDIR=$BASELINER_HOME/tmp/log
    mkdir -p $LOGDIR
    echo "log dir: $LOGDIR"
    export BASELINER_LOGHOME=$LOGDIR
fi

if [ "$BASELINER_ENV" != "" ]; then
        export CATALYST_CONFIG_LOCAL_SUFFIX=$BASELINER_ENV
elif [ "$BALI_ENV" != "" ]; then
        export CATALYST_CONFIG_LOCAL_SUFFIX=$BALI_ENV
fi

LOGFILENAME=balid
NOW=`perl -MDateTime -le 'print DateTime->now()'`
LOGFILEOLD=$LOGDIR/${LOGFILENAME}_${NOW}.log
LOGFILE=$LOGDIR/$LOGFILENAME.log

ren_log() {
    mv "$LOGFILE" "$LOGFILEOLD" 2>/dev/null
    gzip $LOGFILEOLD 2>/dev/null
    echo "Log file: $LOGFILE"
}

message="Baseliner Dispatcher starting in the background..."
if [ "$1" == "restart" ];
then
        bali stop service.dispatcher 
        echo $message
	    ren_log
        shift
        exec balid service.dispatcher $*
        exit 0
fi

if [ "$1" == "stop" ];
then
        shift
        exec bali stop service.dispatcher $*
        exit 0
fi

if [ "$1" == "start" ];
then
        ret=`ps uwwx|grep perl|grep "bali.pl"|grep "service.dispatcher"|grep -v grep`
        if [ "$ret" != "" ];
        then
           echo "Another instance of 'service.dispatcher' is running"
           echo $ret
           exit 1
        else
           ren_log
           echo $message
           shift
           exec balid service.dispatcher $*
           exit 0
        fi
fi

if [ "$1" == "tail" ];
then
        if [ "$BASELINER_LOGHOME" == "" ];
        then
            echo "BASELINER_LOGHOME is not set"
            exit 1
        fi
        echo "Tail following Baseliner log '$BASELINER_LOGHOME/balid.log'..."
        tail -f $BASELINER_LOGHOME/balid.log
        exit 0
fi

if [ "$1" == "log" ];
then
        if [ "$BASELINER_LOGHOME" == "" ];
        then
            echo "BASELINER_LOGHOME is not set"
            exit 1
        fi
        echo "Cat log '$BASELINER_LOGHOME/balid.log'..."
        cat $BASELINER_LOGHOME/balid.log
        exit 0
fi

export BASELINER_PERL_OPTS=-X
exec bali service.dispatcher $*

